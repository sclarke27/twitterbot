!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("recon-js")):"function"==typeof define&&define.amd?define(["exports","recon-js"],e):e(t.swim={},t.recon)}(this,function(t,e){"use strict";function i(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var n,o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},s=function(){function t(){}return t.prototype.tag=function(){return this.constructor.tag()},t.prototype.prio=function(t){return arguments.length?this:void 0},t.prototype.rate=function(t){return arguments.length?this:void 0},t.prototype.toRecon=function(){return e.stringify(this.toValue())},t.fromValue=function(t){switch(e.tag(t)){case"@event":return a.fromValue(t);case"@command":return d.fromValue(t);case"@link":return p.fromValue(t);case"@linked":return u.fromValue(t);case"@sync":return c.fromValue(t);case"@synced":return f.fromValue(t);case"@unlink":return y.fromValue(t);case"@unlinked":return v.fromValue(t);case"@auth":return g.fromValue(t);case"@authed":return m.fromValue(t);case"@deauth":return w.fromValue(t);case"@deauthed":return k.fromValue(t);default:return}},t.parseRecon=function(i){return t.fromValue(e.parse(i))},t.tag=function(){return""},t}(),r=function(t){function n(e){var i=t.call(this)||this;return i.bodyValue=e,i}return i(n,t),n.prototype.node=function(t){return void 0===t?void 0:this},n.prototype.lane=function(t){return void 0===t?void 0:this},n.prototype.body=function(t){return arguments.length?this.copy(t):this.bodyValue},n.prototype.toValue=function(){var t={};return t[this.tag()]=null,e.concat(t,this.bodyValue)},n.fromValue=function(t,i){i=i;if(e.headers(t,i.tag())){return new i(e.body(t))}},n}(s),h=function(t){function n(e,i,n){var o=t.call(this)||this;return o.nodeUri=e,o.laneUri=i,o.bodyValue=n,o}return i(n,t),n.prototype.node=function(t){return void 0===t?this.nodeUri:this.copy(t,this.laneUri,this.bodyValue)},n.prototype.lane=function(t){return void 0===t?this.laneUri:this.copy(this.nodeUri,t,this.bodyValue)},n.prototype.body=function(t){return arguments.length?this.copy(this.nodeUri,this.laneUri,t):this.bodyValue},n.prototype.toValue=function(){var t={node:this.nodeUri,lane:this.laneUri},i={};return i[this.tag()]=t,e.concat(i,this.bodyValue)},n.fromValue=function(t,i){i=i;var n,o,s=e.headers(t,i.tag());if(e.forEach(s,function(t,e,i){"node"===e?n=t:"lane"===e?o=t:0===i?n=t:1===i&&(o=t)}),void 0!==n&&void 0!==o){var r=e.body(t);return new i(n,o,r)}},n}(s),l=function(t){function n(e,i,n,o,s){var r=t.call(this)||this;return r.nodeUri=e,r.laneUri=i,r.prioNumber=n,r.rateNumber=o,r.bodyValue=s,r}return i(n,t),n.prototype.node=function(t){return void 0===t?this.nodeUri:this.copy(t,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue)},n.prototype.lane=function(t){return void 0===t?this.laneUri:this.copy(this.nodeUri,t,this.prioNumber,this.rateNumber,this.bodyValue)},n.prototype.prio=function(t){return arguments.length?this.copy(this.nodeUri,this.laneUri,t,this.rateNumber,this.bodyValue):this.prioNumber},n.prototype.rate=function(t){return arguments.length?this.copy(this.nodeUri,this.laneUri,this.prioNumber,t,this.bodyValue):this.rateNumber},n.prototype.body=function(t){return arguments.length?this.copy(this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,t):this.bodyValue},n.prototype.toValue=function(){var t={node:this.nodeUri,lane:this.laneUri};this.prioNumber&&(t.prio=this.prioNumber),this.rateNumber&&(t.rate=this.rateNumber);var i={};return i[this.tag()]=t,e.concat(i,this.bodyValue)},n.fromValue=function(t,i){i=i;var n,o,s,r,h=e.headers(t,i.tag());if(e.forEach(h,function(t,e,i){"node"===e?n=t:"lane"===e?o=t:"prio"===e?s=t:"rate"===e?r=t:0===i?n=t:1===i&&(o=t)}),void 0!==n&&void 0!==o){var l=e.body(t);return new i(n,o,s,r,l)}},n}(s),a=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}return i(e,t),e.prototype.copy=function(t,i,n){return new e(t,i,n)},e.fromValue=function(t){return h.fromValue(t,e)},e.tag=function(){return"@event"},e}(h),d=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}return i(e,t),e.prototype.copy=function(t,i,n){return new e(t,i,n)},e.fromValue=function(t){return h.fromValue(t,e)},e.tag=function(){return"@command"},e}(h),p=function(t){function e(e,i,n,o,s){return t.call(this,e,i,n,o,s)||this}return i(e,t),e.prototype.copy=function(t,i,n,o,s){return new e(t,i,n,o,s)},e.fromValue=function(t){return l.fromValue(t,e)},e.tag=function(){return"@link"},e}(l),u=function(t){function e(e,i,n,o,s){return t.call(this,e,i,n,o,s)||this}return i(e,t),e.prototype.copy=function(t,i,n,o,s){return new e(t,i,n,o,s)},e.fromValue=function(t){return l.fromValue(t,e)},e.tag=function(){return"@linked"},e}(l),c=function(t){function e(e,i,n,o,s){return t.call(this,e,i,n,o,s)||this}return i(e,t),e.prototype.copy=function(t,i,n,o,s){return new e(t,i,n,o,s)},e.fromValue=function(t){return l.fromValue(t,e)},e.tag=function(){return"@sync"},e}(l),f=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}return i(e,t),e.prototype.copy=function(t,i,n){return new e(t,i,n)},e.fromValue=function(t){return h.fromValue(t,e)},e.tag=function(){return"@synced"},e}(h),y=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}return i(e,t),e.prototype.copy=function(t,i,n){return new e(t,i,n)},e.fromValue=function(t){return h.fromValue(t,e)},e.tag=function(){return"@unlink"},e}(h),v=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}return i(e,t),e.prototype.copy=function(t,i,n){return new e(t,i,n)},e.fromValue=function(t){return h.fromValue(t,e)},e.tag=function(){return"@unlinked"},e}(h),g=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.copy=function(t){return new e(t)},e.fromValue=function(t){return r.fromValue(t,e)},e.tag=function(){return"@auth"},e}(r),m=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.copy=function(t){return new e(t)},e.fromValue=function(t){return r.fromValue(t,e)},e.tag=function(){return"@authed"},e}(r),w=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.copy=function(t){return new e(t)},e.fromValue=function(t){return r.fromValue(t,e)},e.tag=function(){return"@deauth"},e}(r),k=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.copy=function(t){return new e(t)},e.fromValue=function(t){return r.fromValue(t,e)},e.tag=function(){return"@deauthed"},e}(r),U=function(){function t(t,i,n){void 0===n&&(n={}),this.context=t,this.hostUri=i,this.options=n,this.downlinks={},this.downlinkCount=0,this.authenticated=!1,this.sessionValue=void 0,this.uriCache=new e.UriCache(i),this.sendBuffer=[],this.reconnectTimer=0,this.reconnectTimeout=0,this.idleTimer=0,this.open=this.open.bind(this),this.checkIdle=this.checkIdle.bind(this)}return Object.defineProperty(t.prototype,"credentials",{get:function(){return this.options.credentials},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxReconnectTimeout",{get:function(){return this.options.maxReconnectTimeout||3e4},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"idleTimeout",{get:function(){return this.options.idleTimeout||1e3},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sendBufferSize",{get:function(){return this.options.sendBufferSize||1024},enumerable:!0,configurable:!0}),t.prototype.isAuthenticated=function(){return this.authenticated},Object.defineProperty(t.prototype,"session",{get:function(){return this.sessionValue},enumerable:!0,configurable:!0}),t.prototype.isIdle=function(){return!this.sendBuffer.length&&!this.downlinkCount},t.prototype.resolveUri=function(t){return this.uriCache.resolveUri(t)},t.prototype.unresolveUri=function(t){return this.uriCache.unresolveUri(t)},t.prototype.authenticate=function(t){if(!e.equal(this.options.credentials,t))if(this.options.credentials=t,this.isConnected()){var i=new g(t);this.push(i)}else this.open()},t.prototype.openDownlink=function(t){this.clearIdle();var e=this.resolveUri(t.node()),i=t.lane();this.downlinkCount||this.open();var n=this.downlinks[e];if(n||(n={},this.downlinks[e]=n),n[i])throw"duplicate downlink";n[i]=t,this.downlinkCount+=1,t.openUp(this),this.isConnected()&&t.hostDidConnect(this)},t.prototype.unlinkDownlink=function(t){var e=this.resolveUri(t.node()),i=t.lane(),n=this.downlinks[e];if(n&&n[i]&&this.isConnected()){var o=new y(this.unresolveUri(e),i);t.onUnlinkRequest(o,this),this.push(o)}},t.prototype.closeDownlink=function(t){var e=this.resolveUri(t.node()),i=t.lane(),n=this.downlinks[e];n&&n[i]&&(this.downlinkCount-=1,delete n[i],Object.keys(n).length||delete this.downlinks[e],this.downlinkCount||this.watchIdle(),t.closeUp(this))},t.prototype.command=function(t,e,i){t=this.resolveUri(t);var n=new d(this.unresolveUri(t),e,i);this.push(n)},t.prototype.onEnvelope=function(t){t instanceof a?this.onEventMessage(t):t instanceof d?this.onCommandMessage(t):t instanceof p?this.onLinkRequest(t):t instanceof u?this.onLinkedResponse(t):t instanceof c?this.onSyncRequest(t):t instanceof f?this.onSyncedResponse(t):t instanceof y?this.onUnlinkRequest(t):t instanceof v?this.onUnlinkedResponse(t):t instanceof g?this.onAuthRequest(t):t instanceof m?this.onAuthedResponse(t):t instanceof w?this.onDeauthRequest(t):t instanceof k?this.onDeauthedResponse(t):this.onUnknownEnvelope(t)},t.prototype.onEventMessage=function(t){var e=this.resolveUri(t.node()),i=t.lane(),n=this.downlinks[e];if(n){var o=n[i];if(o){var s=t.node(e);o.onEventMessage(s,this)}}},t.prototype.onCommandMessage=function(t){},t.prototype.onLinkRequest=function(t){},t.prototype.onLinkedResponse=function(t){var e=this.resolveUri(t.node()),i=t.lane(),n=this.downlinks[e];if(n){var o=n[i];if(o){var s=t.node(e);o.onLinkedResponse(s,this)}}},t.prototype.onSyncRequest=function(t){},t.prototype.onSyncedResponse=function(t){var e=this.resolveUri(t.node()),i=t.lane(),n=this.downlinks[e];if(n){var o=n[i];if(o){var s=t.node(e);o.onSyncedResponse(s,this)}}},t.prototype.onUnlinkRequest=function(t){},t.prototype.onUnlinkedResponse=function(t){var e=this.resolveUri(t.node()),i=t.lane(),n=this.downlinks[e];if(n){var o=n[i];if(o){var s=t.node(e);o.onUnlinkedResponse(s,this)}}},t.prototype.onAuthRequest=function(t){},t.prototype.onAuthedResponse=function(t){this.authenticated=!0,this.sessionValue=t.body(),this.context.hostDidAuthenticate(t.body(),this)},t.prototype.onDeauthRequest=function(t){},t.prototype.onDeauthedResponse=function(t){this.authenticated=!1,this.sessionValue=void 0,this.context.hostDidDeauthenticate(t.body(),this)},t.prototype.onUnknownEnvelope=function(t){},t.prototype.onConnect=function(){this.reconnectTimeout=0,this.context.hostDidConnect(this);for(var t in this.downlinks){var e=this.downlinks[t];for(var i in e){e[i].hostDidConnect(this)}}},t.prototype.onDisconnect=function(){this.authenticated=!1,this.sessionValue=void 0,this.context.hostDidDisconnect(this);for(var t in this.downlinks){var e=this.downlinks[t];for(var i in e){e[i].hostDidDisconnect(this)}}},t.prototype.onError=function(t){this.context.hostDidFail(t,this);for(var e in this.downlinks){var i=this.downlinks[e];for(var n in i){i[n].hostDidFail(t,this)}}},t.prototype.reconnect=function(){this.reconnectTimer||(this.reconnectTimeout?this.reconnectTimeout=Math.min(Math.floor(1.8*this.reconnectTimeout),this.maxReconnectTimeout):this.reconnectTimeout=Math.floor(500+1e3*Math.random()),this.reconnectTimer=setTimeout(this.open,this.reconnectTimeout))},t.prototype.clearReconnect=function(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=0)},t.prototype.watchIdle=function(){!this.idleTimer&&this.isConnected()&&this.isIdle()&&(this.idleTimer=setTimeout(this.checkIdle,this.idleTimeout))},t.prototype.clearIdle=function(){this.idleTimer&&(clearTimeout(this.idleTimer),this.idleTimer=0)},t.prototype.checkIdle=function(){this.isConnected()&&this.isIdle()&&this.close()},t.prototype.close=function(){this.context.closeHost(this)},t.prototype.closeUp=function(){for(var t in this.downlinks){var e=this.downlinks[t];for(var i in e){e[i].closeUp(this)}}},t}();!function(t){t[t.KeepLinked=1]="KeepLinked",t[t.KeepSynced=2]="KeepSynced",t[t.KeepLinkedSynced=3]="KeepLinkedSynced"}(n||(n={}));var D=function(){function t(t,e,i,n,o,s,r){this.context=t,this.hostUri=e,this.nodeUri=i,this.laneUri=n,this.prioNumber=o,this.rateNumber=s,this.bodyValue=r,this.views=[],this.remoteHost=null,this.status=0}return t.prototype.host=function(){return this.hostUri},t.prototype.node=function(){return this.nodeUri},t.prototype.lane=function(){return this.laneUri},t.prototype.keepLinked=function(){for(var t=0;t<this.views.length;t+=1)if(this.views[t].keepLinked())return!0;return!1},t.prototype.keepSynced=function(){for(var t=0;t<this.views.length;t+=1)if(this.views[t].keepSynced())return!0;return!1},t.prototype.isConnected=function(){return!(!this.remoteHost||!this.remoteHost.isConnected())},t.prototype.isAuthenticated=function(){return!(!this.remoteHost||!this.remoteHost.isAuthenticated())},t.prototype.isLinked=function(){return 0!=(2&this.status)},t.prototype.isSynced=function(){return 0!=(8&this.status)},Object.defineProperty(t.prototype,"session",{get:function(){return this.remoteHost&&this.remoteHost.session},enumerable:!0,configurable:!0}),t.prototype.addDownlink=function(t){this.views.push(t)},t.prototype.removeDownlink=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e]===t&&(this.views.splice(e,1),t.closeUp());0===this.views.length&&this.unlink()},t.prototype.onEventMessage=function(t,e){for(var i=0;i<this.views.length;i+=1)this.views[i].onEventMessage(t)},t.prototype.onCommandMessage=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].onCommandMessage(t)},t.prototype.onLinkRequest=function(t){this.status|=1;for(var e=0;e<this.views.length;e+=1)this.views[e].onLinkRequest(t)},t.prototype.onLinkedResponse=function(t,e){this.status=-2&this.status|2;for(var i=0;i<this.views.length;i+=1)this.views[i].onLinkedResponse(t)},t.prototype.onSyncRequest=function(t){this.status|=4;for(var e=0;e<this.views.length;e+=1)this.views[e].onSyncRequest(t)},t.prototype.onSyncedResponse=function(t,e){this.status=-5&this.status|8;for(var i=0;i<this.views.length;i+=1)this.views[i].onSyncedResponse(t)},t.prototype.onUnlinkRequest=function(t,e){this.status=-6&this.status|16;for(var i=0;i<this.views.length;i+=1)this.views[i].onUnlinkRequest(t)},t.prototype.onUnlinkedResponse=function(t,e){this.status&=-17;for(var i=0;i<this.views.length;i+=1)this.views[i].onUnlinkedResponse(t);0===this.status&&this.close()},t.prototype.hostDidConnect=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].hostDidConnect();var i,n=this.remoteHost.unresolveUri(this.nodeUri);this.keepSynced()?(i=new c(n,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue),this.onSyncRequest(i)):(i=new p(n,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue),this.onLinkRequest(i)),this.remoteHost.push(i)},t.prototype.hostDidDisconnect=function(t){this.status=0;for(var e=!1,i=0;i<this.views.length;i+=1){var n=this.views[i];n.hostDidDisconnect(),e=e||n.keepLinked()}e||this.close()},t.prototype.hostDidFail=function(t,e){for(var i=0;i<this.views.length;i+=1)this.views[i].hostDidFail(t)},t.prototype.command=function(t){this.onCommandMessage(t),this.remoteHost.command(this.nodeUri,this.laneUri,t)},t.prototype.unlink=function(){this.status=16,this.context.unlinkDownlink(this)},t.prototype.close=function(){this.context.closeDownlink(this)},t.prototype.openUp=function(t){this.remoteHost=t;for(var e=0;e<this.views.length;e+=1)this.views[e].openUp(t)},t.prototype.closeUp=function(){var t=this.views;this.views=[];for(var e=0;e<t.length;e+=1)t[e].closeUp()},t}(),b=function(){function t(t,e,i,n,o,s,r,h,l,a){void 0===l&&(l=0),void 0===a&&(a={}),this.context=t,this.scope=e,this.hostUri=i,this.nodeUri=n,this.laneUri=o,this.prioNumber=s,this.rateNumber=r,this.bodyValue=h,this.flags=l,this.delegate=a,this.model=void 0}return t.prototype.host=function(t){return arguments.length?this.copy(this.context,this.scope,t,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,this.flags,this.delegate):this.hostUri},t.prototype.node=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,t,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,this.flags,this.delegate):this.nodeUri},t.prototype.lane=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,t,this.prioNumber,this.rateNumber,this.bodyValue,this.flags,this.delegate):this.laneUri},t.prototype.prio=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,t,this.rateNumber,this.bodyValue,this.flags,this.delegate):this.prioNumber},t.prototype.rate=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,t,this.bodyValue,this.flags,this.delegate):this.rateNumber},t.prototype.body=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,t,this.flags,this.delegate):this.bodyValue},t.prototype.keepLinked=function(t){if(arguments.length){var e=t?1|this.flags:-2&this.flags;return this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,e,this.delegate)}return 0!=(1&this.flags)},t.prototype.keepSynced=function(t){if(arguments.length){var e=t?2|this.flags:-3&this.flags;return this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,e,this.delegate)}return 0!=(2&this.flags)},t.prototype.onEvent=function(t){return arguments.length?(this.delegate.onEvent=t,this):this.delegate.onEvent},t.prototype.onCommand=function(t){return arguments.length?(this.delegate.onCommand=t,this):this.delegate.onCommand},t.prototype.willLink=function(t){return arguments.length?(this.delegate.willLink=t,this):this.delegate.willLink},t.prototype.didLink=function(t){return arguments.length?(this.delegate.didLink=t,this):this.delegate.didLink},t.prototype.willSync=function(t){return arguments.length?(this.delegate.willSync=t,this):this.delegate.willSync},t.prototype.didSync=function(t){return arguments.length?(this.delegate.didSync=t,this):this.delegate.didSync},t.prototype.willUnlink=function(t){return arguments.length?(this.delegate.willUnlink=t,this):this.delegate.willUnlink},t.prototype.didUnlink=function(t){return arguments.length?(this.delegate.didUnlink=t,this):this.delegate.didUnlink},t.prototype.didConnect=function(t){return arguments.length?(this.delegate.didConnect=t,this):this.delegate.didConnect},t.prototype.didDisconnect=function(t){return arguments.length?(this.delegate.didDisconnect=t,this):this.delegate.didDisconnect},t.prototype.didClose=function(t){return arguments.length?(this.delegate.didClose=t,this):this.delegate.didClose},t.prototype.didFail=function(t){return arguments.length?(this.delegate.didFail=t,this):this.delegate.didFail},t.prototype.isConnected=function(){return!(!this.model||!this.model.isConnected())},t.prototype.isAuthenticated=function(){return!(!this.model||!this.model.isAuthenticated())},t.prototype.isLinked=function(){return!(!this.model||!this.model.isLinked())},t.prototype.isSynced=function(){return!(!this.model||!this.model.isSynced())},t.prototype.session=function(){return this.model&&this.model.session},t.prototype.onEventMessage=function(t){this.delegate.onEvent&&this.delegate.onEvent(t.body(),this)},t.prototype.onCommandMessage=function(t){this.delegate.onCommand&&this.delegate.onCommand(t,this)},t.prototype.onLinkRequest=function(t){this.delegate.willLink&&this.delegate.willLink(this)},t.prototype.onLinkedResponse=function(t){this.delegate.didLink&&this.delegate.didLink(this)},t.prototype.onSyncRequest=function(t){this.delegate.willSync&&this.delegate.willSync(this)},t.prototype.onSyncedResponse=function(t){this.delegate.didSync&&this.delegate.didSync(this)},t.prototype.onUnlinkRequest=function(t){this.delegate.willUnlink&&this.delegate.willUnlink(this)},t.prototype.onUnlinkedResponse=function(t){this.delegate.didUnlink&&this.delegate.didUnlink(this)},t.prototype.hostDidConnect=function(){this.delegate.didConnect&&this.delegate.didConnect(this)},t.prototype.hostDidDisconnect=function(){this.delegate.didDisconnect&&this.delegate.didDisconnect(this)},t.prototype.hostDidFail=function(t){this.delegate.didFail&&this.delegate.didFail(t,this)},t.prototype.command=function(t){this.model.command(t)},t.prototype.close=function(){this.scope&&this.scope.removeDownlink(this),this.model&&this.model.removeDownlink(this)},t.prototype.openUp=function(t){},t.prototype.closeUp=function(){this.delegate.didClose&&this.delegate.didClose(this)},t}(),R=function(t){function e(e,i,n,o,s,r,h){return t.call(this,e,i,n,o,s,r,h)||this}return i(e,t),e}(D),C=function(t){function n(e,i,n,o,s,r,h,l,a,d){return void 0===a&&(a=1),void 0===d&&(d={}),t.call(this,e,i,n,o,s,r,h,l,a,d)||this}return i(n,t),n.prototype.copy=function(t,e,i,o,s,r,h,l,a,d){return new n(t,e,i,o,s,r,h,l,a,d)},n.prototype.open=function(){var t=this.laneUri;if(!t)throw"undefined laneUri";var i=this.nodeUri;if(!i)throw"undefined nodeUri";var n=this.hostUri;n||(n=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(n,i));var o=this.context.getDownlink(n,i,t);if(o){if(!(o instanceof R))throw"downlink type mismatch";o.addDownlink(this)}else(o=new R(this.context,n,i,t,this.prioNumber,this.rateNumber,this.bodyValue)).addDownlink(this),this.context.openDownlink(o);return this.model=o,this.scope&&this.scope.addDownlink(this),this},n}(b),S=function(t){function n(i,n,o,s,r,h,l,a){void 0===a&&(a=new e.STree);var d=t.call(this,i,n,o,s,r,h,l)||this;return d.state=a,d}return i(n,t),Object.defineProperty(n.prototype,"length",{get:function(){return this.state.length},enumerable:!0,configurable:!0}),n.prototype.isEmpty=function(){return this.state.isEmpty()},n.prototype.get=function(t,e){return this.state.get(t,e)},n.prototype.getEntry=function(t,e){return this.state.getEntry(t,e)},n.prototype.set=function(t,i,n){if(void 0!==n&&(t=this.state.lookup(n,t))<0)throw new RangeError(""+n);if(t<0||t>=this.state.length)throw new RangeError(""+t);i=this.listWillUpdate(t,i);var o=this.state.getEntry(t);return this.state.set(t,i),this.listDidUpdate(t,i,o[1]),this.command(e.concat({"@update":{id:o[0],index:t}},i)),this},n.prototype.insert=function(t,i,n){if(t<0||t>this.state.length)throw new RangeError(""+t);i=this.listWillInsert(t,i),this.state.insert(t,i,n);var o=this.state.getEntry(t);return this.listDidInsert(t,i),this.command(e.concat({"@insert":{id:o[0],index:t}},i)),this},n.prototype.remove=function(t,e){if(void 0!==e&&(t=this.state.lookup(e,t))<0)throw new RangeError(""+e);if(t<0||t>this.state.length)throw new RangeError(""+t);this.listWillRemove(t);var i=this.state.getEntry(t);return this.state.remove(t),this.listDidRemove(t,i[1]),this.command({"@remove":{id:i[0],index:t}}),this},n.prototype.push=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];for(var n=0;n<t.length;n+=1){var o=this.state.length+n,s=this.listWillInsert(o,t[n]);this.state.insert(o,s);var r=this.state.getEntry(o);this.listDidInsert(o,s),this.command(e.concat({"@insert":{id:r[0],index:o}},s))}return this.state.length},n.prototype.pop=function(){var t=this.state.length-1;if(t>=0){this.listWillRemove(t);var e=this.state.getEntry(t);return this.state.remove(t),this.listDidRemove(t,e[1]),this.command({"@remove":{id:e[0],index:t}}),e[1]}},n.prototype.unshift=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];for(var n=t.length-1;n>=0;n-=1){var o=this.listWillInsert(0,t[n]);this.state.insert(0,o);var s=this.state.getEntry(0);this.listDidInsert(0,o),this.command(e.concat({"@insert":{id:s[0],index:0}},o))}return this.state.length},n.prototype.shift=function(){if(this.state.length>0){this.listWillRemove(0);var t=this.state.getEntry(0);return this.state.remove(0),this.listDidRemove(0,t[1]),this.command({"@remove":{id:t[0],index:0}}),t[1]}},n.prototype.move=function(t,e,i){if(void 0!==i&&(t=this.state.lookup(i,t))<0)throw new RangeError(""+i);if(t<0||t>=this.state.length)throw new RangeError(""+t);if(e<0||e>=this.state.length)throw new RangeError(""+e);if(t!==e){var n=this.state.getEntry(t);this.listWillMove(t,e,n[1]),this.state.remove(t).insert(e,n[1],n[0]),this.listDidMove(t,e,n[1]),this.command({"@move":{id:n[0],from:t,to:e}})}return this},n.prototype.splice=function(t,i){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];t<0&&(t=this.state.length+t),t=Math.min(Math.max(0,t),this.state.length),void 0===i&&(i=this.state.length-t);for(var s=[],r=t,h=t+i;r<h;r+=1){this.listWillRemove(t);var l=this.state.getEntry(t);s.push(l[1]),this.state.remove(t),this.listDidRemove(t,l[1]),this.command({"@remove":{id:l[0],index:t}})}for(r=0;r<n.length;r+=1){var a=t+r,d=this.listWillInsert(a,n[r]);this.state.insert(a,d);var p=this.state.getEntry(a);this.listDidInsert(a,d),this.command(e.concat({"@insert":{id:p[0],index:a}},d))}return s},n.prototype.clear=function(){this.listWillClear(),this.state.clear(),this.listDidClear(),this.command({"@clear":null})},n.prototype.forEach=function(t,e){this.state.forEach(function(i,n,o,s){t.call(e,i,n,this,s)},this)},n.prototype.values=function(){return this.state.values()},n.prototype.keys=function(){return this.state.keys()},n.prototype.entries=function(){return this.state.entries()},n.prototype.snapshot=function(){return this.state.clone()},n.prototype.setState=function(t){this.state=t},n.prototype.onEventMessage=function(i,n){t.prototype.onEventMessage.call(this,i,n);var o=i.body(),s=e.tag(o);if("@update"===s){r=o[s];(h=this.state.lookup(r.id,r.index))>=0?this.onUpdateEvent(h,e.body(o),r.id):this.onInsertEvent(r.index,e.body(o),r.id)}else if("@insert"===s){r=o[s];(h=this.state.lookup(r.id,r.index))<0?this.onInsertEvent(r.index,e.body(o),r.id):this.onUpdateEvent(h,e.body(o),r.id)}else if("@move"===s){r=o[s];(h=this.state.lookup(r.id,r.from))>=0&&this.onMoveEvent(h,r.to,r.id)}else if("@remove"===s){var r=o[s],h=this.state.lookup(r.id,r.index);h>=0&&this.onRemoveEvent(h,r.id)}else if("@drop"===s){r=o[s];this.onDropEvent(r)}else if("@take"===s){r=o[s];this.onTakeEvent(r)}else"@clear"===s&&this.onClearEvent()},n.prototype.onUpdateEvent=function(t,e,i){e=this.listWillUpdate(t,e);var n=this.state.get(t);this.state.set(t,e),this.listDidUpdate(t,e,n)},n.prototype.onInsertEvent=function(t,e,i){e=this.listWillInsert(t,e),this.state.insert(t,e,i),this.listDidInsert(t,e)},n.prototype.onMoveEvent=function(t,e,i){if(e=Math.min(Math.max(0,e),this.state.length),t!==e){var n=this.state.get(t);this.listWillMove(t,e,n),this.state.remove(t).insert(e,n,i),this.listDidMove(t,e,n)}},n.prototype.onRemoveEvent=function(t,e){this.listWillRemove(t);var i=this.state.get(t);this.state.remove(t),this.listDidRemove(t,i)},n.prototype.onDropEvent=function(t){this.listWillDrop(t),this.state.drop(t),this.listDidDrop(t)},n.prototype.onTakeEvent=function(t){this.listWillTake(t),this.state.take(t),this.listDidTake(t)},n.prototype.onClearEvent=function(){this.listWillClear(),this.state.clear(),this.listDidClear()},n.prototype.listWillInsert=function(t,e){for(var i=0;i<this.views.length;i+=1)e=this.views[i].listWillInsert(t,e);return e},n.prototype.listDidInsert=function(t,e){for(var i=0;i<this.views.length;i+=1)this.views[i].listDidInsert(t,e)},n.prototype.listWillUpdate=function(t,e){for(var i=0;i<this.views.length;i+=1)e=this.views[i].listWillUpdate(t,e);return e},n.prototype.listDidUpdate=function(t,e,i){for(var n=0;n<this.views.length;n+=1)this.views[n].listDidUpdate(t,e,i)},n.prototype.listWillMove=function(t,e,i){for(var n=0;n<this.views.length;n+=1)this.views[n].listWillMove(t,e,i)},n.prototype.listDidMove=function(t,e,i){for(var n=0;n<this.views.length;n+=1)this.views[n].listDidMove(t,e,i)},n.prototype.listWillRemove=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].listWillRemove(t)},n.prototype.listDidRemove=function(t,e){for(var i=0;i<this.views.length;i+=1)this.views[i].listDidRemove(t,e)},n.prototype.listWillDrop=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].listWillDrop(t)},n.prototype.listDidDrop=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].listDidDrop(t)},n.prototype.listWillTake=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].listWillTake(t)},n.prototype.listDidTake=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].listDidTake(t)},n.prototype.listWillClear=function(){for(var t=0;t<this.views.length;t+=1)this.views[t].listWillClear()},n.prototype.listDidClear=function(){for(var t=0;t<this.views.length;t+=1)this.views[t].listDidClear()},n}(D),E=function(t){function n(e,i,n,o,s,r,h,l,a,d,p){void 0===a&&(a=3),void 0===d&&(d={});var u=t.call(this,e,i,n,o,s,r,h,l,a,d)||this;return u.state0=p,u}return i(n,t),n.prototype.copy=function(t,e,i,o,s,r,h,l,a,d,p){return 10===arguments.length&&(p=this.state0),new n(t,e,i,o,s,r,h,l,a,d,p)},Object.defineProperty(n.prototype,"length",{get:function(){return this.model.length},enumerable:!0,configurable:!0}),n.prototype.get=function(t,e){return this.model.get(t,e)},n.prototype.getEntry=function(t,e){return this.model.getEntry(t,e)},n.prototype.set=function(t,e,i){return this.model.set(t,e,i),this},n.prototype.insert=function(t,e,i){return this.model.insert(t,e,i),this},n.prototype.remove=function(t,e){return this.model.remove(t,e),this},n.prototype.push=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(i=this.model).push.apply(i,t);var i},n.prototype.pop=function(){return this.model.pop()},n.prototype.unshift=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(i=this.model).unshift.apply(i,t);var i},n.prototype.shift=function(){return this.model.shift()},n.prototype.move=function(t,e,i){return this.model.move(t,e,i),this},n.prototype.splice=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];return(o=this.model).splice.apply(o,[t,e].concat(i));var o},n.prototype.clear=function(){this.model.clear()},n.prototype.forEach=function(t,e){this.model.state.forEach(function(i,n,o,s){t.call(e,i,n,this,s)},this)},n.prototype.values=function(){return this.model.values()},n.prototype.keys=function(){return this.model.keys()},n.prototype.entries=function(){return this.model.entries()},n.prototype.snapshot=function(){return this.model.snapshot()},n.prototype.setState=function(t){this.model.setState(t)},n.prototype.willInsert=function(t){return arguments.length?(this.delegate.willInsert=t,this):this.delegate.willInsert},n.prototype.didInsert=function(t){return arguments.length?(this.delegate.didInsert=t,this):this.delegate.didInsert},n.prototype.willUpdate=function(t){return arguments.length?(this.delegate.willUpdate=t,this):this.delegate.willUpdate},n.prototype.didUpdate=function(t){return arguments.length?(this.delegate.didUpdate=t,this):this.delegate.didUpdate},n.prototype.willMove=function(t){return arguments.length?(this.delegate.willMove=t,this):this.delegate.willMove},n.prototype.didMove=function(t){return arguments.length?(this.delegate.didMove=t,this):this.delegate.didMove},n.prototype.willRemove=function(t){return arguments.length?(this.delegate.willRemove=t,this):this.delegate.willRemove},n.prototype.didRemove=function(t){return arguments.length?(this.delegate.didRemove=t,this):this.delegate.didRemove},n.prototype.willDrop=function(t){return arguments.length?(this.delegate.willDrop=t,this):this.delegate.willDrop},n.prototype.didDrop=function(t){return arguments.length?(this.delegate.didDrop=t,this):this.delegate.didDrop},n.prototype.willTake=function(t){return arguments.length?(this.delegate.willTake=t,this):this.delegate.willTake},n.prototype.didTake=function(t){return arguments.length?(this.delegate.didTake=t,this):this.delegate.didTake},n.prototype.willClear=function(t){return arguments.length?(this.delegate.willClear=t,this):this.delegate.willClear},n.prototype.didClear=function(t){return arguments.length?(this.delegate.didClear=t,this):this.delegate.didClear},n.prototype.listWillInsert=function(t,e){if(this.delegate.willInsert){var i=this.delegate.willInsert(t,e,this);void 0!==i&&(e=i)}return e},n.prototype.listDidInsert=function(t,e){this.delegate.didInsert&&this.delegate.didInsert(t,e,this)},n.prototype.listWillUpdate=function(t,e){if(this.delegate.willUpdate){var i=this.delegate.willUpdate(t,e,this);void 0!==i&&(e=i)}return e},n.prototype.listDidUpdate=function(t,e,i){this.delegate.didUpdate&&this.delegate.didUpdate(t,e,i,this)},n.prototype.listWillMove=function(t,e,i){this.delegate.willMove&&this.delegate.willMove(t,e,i,this)},n.prototype.listDidMove=function(t,e,i){this.delegate.didMove&&this.delegate.didMove(t,e,i,this)},n.prototype.listWillRemove=function(t){this.delegate.willRemove&&this.delegate.willRemove(t,this)},n.prototype.listDidRemove=function(t,e){this.delegate.didRemove&&this.delegate.didRemove(t,e,this)},n.prototype.listWillDrop=function(t){this.delegate.willDrop&&this.delegate.willDrop(t,this)},n.prototype.listDidDrop=function(t){this.delegate.didDrop&&this.delegate.didDrop(t,this)},n.prototype.listWillTake=function(t){this.delegate.willTake&&this.delegate.willTake(t,this)},n.prototype.listDidTake=function(t){this.delegate.didTake&&this.delegate.didTake(t,this)},n.prototype.listWillClear=function(){this.delegate.willClear&&this.delegate.willClear(this)},n.prototype.listDidClear=function(){this.delegate.didClear&&this.delegate.didClear(this)},n.prototype.initialState=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,this.flags,this.delegate,t):this.state0},n.prototype.didAliasModel=function(){this.onLinkedResponse(),this.model.state.forEach(function(t,e){this.listDidInsert(e,t)},this),this.onSyncedResponse()},n.prototype.open=function(){var t=this.laneUri;if(!t)throw"undefined laneUri";var i=this.nodeUri;if(!i)throw"undefined nodeUri";var n=this.hostUri;n||(n=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(n,i));var o=this.context.getDownlink(n,i,t);if(o){if(!(o instanceof S))throw"downlink type mismatch";o.addDownlink(this),this.model=o,this.didAliasModel()}else(o=new S(this.context,n,i,t,this.prioNumber,this.rateNumber,this.bodyValue,this.state0)).addDownlink(this),this.context.openDownlink(o),this.model=o;return this.scope&&this.scope.addDownlink(this),this},n}(b),W=function(t){function n(i,n,o,s,r,h,l,a){void 0===a&&(a=new e.BTree);var d=t.call(this,i,n,o,s,r,h,l)||this;return d.state=a,d}return i(n,t),Object.defineProperty(n.prototype,"size",{get:function(){return this.state.size},enumerable:!0,configurable:!0}),n.prototype.isEmpty=function(){return this.state.isEmpty()},n.prototype.has=function(t){return this.state.has(t)},n.prototype.get=function(t){return this.state.get(t)},n.prototype.getEntry=function(t){return this.state.getEntry(t)},n.prototype.set=function(t,i){i=this.mapWillUpdate(t,i);var n=this.state.get(t);return this.state.set(t,i),this.mapDidUpdate(t,i,n),this.command(e.concat({"@update":{key:t}},i)),this},n.prototype.delete=function(t){if(this.state.has(t)){this.mapWillRemove(t);var e=this.state.get(t);return this.state.delete(t),this.mapDidRemove(t,e),this.command({"@remove":{key:t}}),!0}return!1},n.prototype.drop=function(t){return this.mapWillDrop(t),this.state.drop(t),this.mapDidDrop(t),this.command({"@drop":t}),this},n.prototype.take=function(t){return this.mapWillTake(t),this.state.take(t),this.mapDidTake(t),this.command({"@take":t}),this},n.prototype.clear=function(){this.mapWillClear(),this.state.clear(),this.mapDidClear(),this.command({"@clear":null})},n.prototype.forEach=function(t,e){this.state.forEach(function(i,n){t.call(e,i,n,this)},this)},n.prototype.keys=function(){return this.state.keys()},n.prototype.values=function(){return this.state.values()},n.prototype.entries=function(){return this.state.entries()},n.prototype.snapshot=function(){return this.state.clone()},n.prototype.setState=function(t){this.state=t},n.prototype.onEventMessage=function(i,n){t.prototype.onEventMessage.call(this,i,n);var o=i.body(),s=e.tag(o);if("@update"===s){r=o[s];this.onUpdateEvent(r.key,e.body(o))}else if("@remove"===s){r=o[s];this.onRemoveEvent(r.key)}else if("@drop"===s){r=o[s];this.onDropEvent(r)}else if("@take"===s){var r=o[s];this.onTakeEvent(r)}else"@clear"===s&&this.onClearEvent()},n.prototype.onUpdateEvent=function(t,e){e=this.mapWillUpdate(t,e);var i=this.state.get(t);this.state.set(t,e),this.mapDidUpdate(t,e,i)},n.prototype.onRemoveEvent=function(t){this.mapWillRemove(t);var e=this.state.get(t);this.state.delete(t),this.mapDidRemove(t,e)},n.prototype.onDropEvent=function(t){this.mapWillDrop(t),this.state.drop(t),this.mapDidDrop(t)},n.prototype.onTakeEvent=function(t){this.mapWillTake(t),this.state.take(t),this.mapDidTake(t)},n.prototype.onClearEvent=function(){this.mapWillClear(),this.state.clear(),this.mapDidClear()},n.prototype.mapWillUpdate=function(t,e){for(var i=0;i<this.views.length;i+=1)e=this.views[i].mapWillUpdate(t,e);return e},n.prototype.mapDidUpdate=function(t,e,i){for(var n=0;n<this.views.length;n+=1)this.views[n].mapDidUpdate(t,e,i)},n.prototype.mapWillRemove=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].mapWillRemove(t)},n.prototype.mapDidRemove=function(t,e){for(var i=0;i<this.views.length;i+=1)this.views[i].mapDidRemove(t,e)},n.prototype.mapWillDrop=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].mapWillDrop(t)},n.prototype.mapDidDrop=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].mapDidDrop(t)},n.prototype.mapWillTake=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].mapWillTake(t)},n.prototype.mapDidTake=function(t){for(var e=0;e<this.views.length;e+=1)this.views[e].mapDidTake(t)},n.prototype.mapWillClear=function(){for(var t=0;t<this.views.length;t+=1)this.views[t].mapWillClear()},n.prototype.mapDidClear=function(){for(var t=0;t<this.views.length;t+=1)this.views[t].mapDidClear()},n}(D),V=function(t){function n(e,i,n,o,s,r,h,l,a,d,p){void 0===a&&(a=3),void 0===d&&(d={});var u=t.call(this,e,i,n,o,s,r,h,l,a,d)||this;return u.state0=p,u}return i(n,t),n.prototype.copy=function(t,e,i,o,s,r,h,l,a,d,p){return 10===arguments.length&&(p=this.state0),new n(t,e,i,o,s,r,h,l,a,d,p)},Object.defineProperty(n.prototype,"size",{get:function(){return this.model.size},enumerable:!0,configurable:!0}),n.prototype.isEmpty=function(){return this.model.isEmpty()},n.prototype.has=function(t){return this.model.has(t)},n.prototype.get=function(t){return this.model.get(t)},n.prototype.getEntry=function(t){return this.model.getEntry(t)},n.prototype.set=function(t,e){return this.model.set(t,e),this},n.prototype.delete=function(t){return this.model.delete(t)},n.prototype.drop=function(t){return this.model.drop(t),this},n.prototype.take=function(t){return this.model.take(t),this},n.prototype.clear=function(){this.model.clear()},n.prototype.forEach=function(t,e){this.model.state.forEach(function(i,n){t.call(e,i,n,this)},this)},n.prototype.keys=function(){return this.model.keys()},n.prototype.values=function(){return this.model.values()},n.prototype.entries=function(){return this.model.entries()},n.prototype.snapshot=function(){return this.model.snapshot()},n.prototype.setState=function(t){this.model.setState(t)},n.prototype.willUpdate=function(t){return arguments.length?(this.delegate.willUpdate=t,this):this.delegate.willUpdate},n.prototype.didUpdate=function(t){return arguments.length?(this.delegate.didUpdate=t,this):this.delegate.didUpdate},n.prototype.willRemove=function(t){return arguments.length?(this.delegate.willRemove=t,this):this.delegate.willRemove},n.prototype.didRemove=function(t){return arguments.length?(this.delegate.didRemove=t,this):this.delegate.didRemove},n.prototype.willDrop=function(t){return arguments.length?(this.delegate.willDrop=t,this):this.delegate.willDrop},n.prototype.didDrop=function(t){return arguments.length?(this.delegate.didDrop=t,this):this.delegate.didDrop},n.prototype.willTake=function(t){return arguments.length?(this.delegate.willTake=t,this):this.delegate.willTake},n.prototype.didTake=function(t){return arguments.length?(this.delegate.didTake=t,this):this.delegate.didTake},n.prototype.willClear=function(t){return arguments.length?(this.delegate.willClear=t,this):this.delegate.willClear},n.prototype.didClear=function(t){return arguments.length?(this.delegate.didClear=t,this):this.delegate.didClear},n.prototype.mapWillUpdate=function(t,e){if(this.delegate.willUpdate){var i=this.delegate.willUpdate(t,e,this);void 0!==i&&(e=i)}return e},n.prototype.mapDidUpdate=function(t,e,i){this.delegate.didUpdate&&this.delegate.didUpdate(t,e,i,this)},n.prototype.mapWillRemove=function(t){this.delegate.willRemove&&this.delegate.willRemove(t,this)},n.prototype.mapDidRemove=function(t,e){this.delegate.didRemove&&this.delegate.didRemove(t,e,this)},n.prototype.mapWillDrop=function(t){this.delegate.willDrop&&this.delegate.willDrop(t,this)},n.prototype.mapDidDrop=function(t){this.delegate.didDrop&&this.delegate.didDrop(t,this)},n.prototype.mapWillTake=function(t){this.delegate.willTake&&this.delegate.willTake(t,this)},n.prototype.mapDidTake=function(t){this.delegate.didTake&&this.delegate.didTake(t,this)},n.prototype.mapWillClear=function(){this.delegate.willClear&&this.delegate.willClear(this)},n.prototype.mapDidClear=function(){this.delegate.didClear&&this.delegate.didClear(this)},n.prototype.initialState=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,this.flags,this.delegate,t):this.state0},n.prototype.didAliasModel=function(){this.onLinkedResponse(),this.model.state.forEach(function(t,e){this.mapDidUpdate(e,t,void 0)},this),this.onSyncedResponse()},n.prototype.open=function(){var t=this.laneUri;if(!t)throw"undefined laneUri";var i=this.nodeUri;if(!i)throw"undefined nodeUri";var n=this.hostUri;n||(n=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(n,i));var o=this.context.getDownlink(n,i,t);if(o){if(!(o instanceof W))throw"downlink type mismatch";o.addDownlink(this),this.model=o,this.didAliasModel()}else(o=new W(this.context,n,i,t,this.prioNumber,this.rateNumber,this.bodyValue,this.state0)).addDownlink(this),this.context.openDownlink(o),this.model=o;return this.scope&&this.scope.addDownlink(this),this},n}(b),x=function(t){function e(e,i,n,o,s,r,h,l){var a=t.call(this,e,i,n,o,s,r,h)||this;return a.state=l,a}return i(e,t),e.prototype.get=function(){return this.state},e.prototype.set=function(t){t=this.valueWillSet(t);var e=this.state;this.setState(t),this.valueDidSet(t,e),this.command(t)},e.prototype.setState=function(t){this.state=t},e.prototype.onEventMessage=function(e,i){t.prototype.onEventMessage.call(this,e,i),this.onSetEvent(e.body())},e.prototype.onSetEvent=function(t){t=this.valueWillSet(t);var e=this.state;this.setState(t),this.valueDidSet(t,e)},e.prototype.valueWillSet=function(t){for(var e=0;e<this.views.length;e+=1)t=this.views[e].valueWillSet(t);return t},e.prototype.valueDidSet=function(t,e){for(var i=0;i<this.views.length;i+=1)this.views[i].valueDidSet(t,e)},e}(D),T=function(t){function n(e,i,n,o,s,r,h,l,a,d,p){void 0===a&&(a=3),void 0===d&&(d={});var u=t.call(this,e,i,n,o,s,r,h,l,a,d)||this;return u.state0=p,u}return i(n,t),n.prototype.copy=function(t,e,i,o,s,r,h,l,a,d,p){return 10===arguments.length&&(p=this.state0),new n(t,e,i,o,s,r,h,l,a,d,p)},n.prototype.get=function(){return this.model.get()},n.prototype.set=function(t){this.model.set(t)},n.prototype.setState=function(t){this.model.setState(t)},n.prototype.willSet=function(t){return arguments.length?(this.delegate.willSet=t,this):this.delegate.willSet},n.prototype.didSet=function(t){return arguments.length?(this.delegate.didSet=t,this):this.delegate.didSet},n.prototype.valueWillSet=function(t){if(this.delegate.willSet){var e=this.delegate.willSet(t,this);void 0!==e&&(t=e)}return t},n.prototype.valueDidSet=function(t,e){this.delegate.didSet&&this.delegate.didSet(t,e,this)},n.prototype.initialState=function(t){return arguments.length?this.copy(this.context,this.scope,this.hostUri,this.nodeUri,this.laneUri,this.prioNumber,this.rateNumber,this.bodyValue,this.flags,this.delegate,t):this.state0},n.prototype.didAliasModel=function(){this.onLinkedResponse(),this.valueDidSet(this.get(),void 0),this.onSyncedResponse()},n.prototype.open=function(){var t=this.laneUri;if(!t)throw"undefined laneUri";var i=this.nodeUri;if(!i)throw"undefined nodeUri";var n=this.hostUri;n||(n=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(n,i));var o=this.context.getDownlink(n,i,t);if(o){if(!(o instanceof x))throw"downlink type mismatch";o.addDownlink(this),this.model=o,this.didAliasModel()}else(o=new x(this.context,n,i,t,this.prioNumber,this.rateNumber,this.bodyValue,this.state0)).addDownlink(this),this.context.openDownlink(o),this.model=o;return this.scope&&this.scope.addDownlink(this),this},n}(b),M=function(){function t(t){this.context=t,this.remoteHost=void 0,this.downlinks={},this.downlinkCount=0,this.delegate={}}return t.prototype.isConnected=function(){return!(!this.remoteHost||!this.remoteHost.isConnected())},t.prototype.isAuthenticated=function(){return!(!this.remoteHost||!this.remoteHost.isAuthenticated())},Object.defineProperty(t.prototype,"session",{get:function(){return this.remoteHost&&this.remoteHost.session},enumerable:!0,configurable:!0}),t.prototype.authenticate=function(t){this.context.authenticate(this.host(),t)},t.prototype.addDownlink=function(t){var e=t.host(),i=t.node(),n=t.lane();0===this.downlinkCount&&this.open();var o=this.downlinks[e];o||(o={},this.downlinks[e]=o);var s=o[i];s||(s={},o[i]=s);var r=s[n];r||(r=[],s[n]=r),r.push(t),this.downlinkCount+=1},t.prototype.removeDownlink=function(t){var e=t.host(),i=t.node(),n=t.lane(),o=this.downlinks[e];if(o){var s=o[i];if(s){var r=s[n];if(r)for(var h=0;h<r.length;h+=1)if(r[h]===t){this.downlinkCount-=1,r.splice(h,1),0===r.length&&(delete s[n],0===Object.keys(s).length&&(delete o[i],0===Object.keys(o).length&&delete this.downlinks[e])),0===this.downlinkCount&&this.close();break}}}},t.prototype.open=function(){this.context.openScope(this)},t.prototype.close=function(){this.context.closeScope(this)},t.prototype.closeUp=function(){var t=this.downlinks;this.downlinks={},this.downlinkCount=0;for(var e in t){var i=t[e];for(var n in i){var o=i[n];for(var s in o)for(var r=o[s],h=0;h<r.length;h+=1)r[h].close()}}},t.prototype.didConnect=function(t){return arguments.length?(this.delegate.didConnect=t,this):this.delegate.didConnect},t.prototype.didAuthenticate=function(t){return arguments.length?(this.delegate.didAuthenticate=t,this):this.delegate.didAuthenticate},t.prototype.didDeauthenticate=function(t){return arguments.length?(this.delegate.didDeauthenticate=t,this):this.delegate.didDeauthenticate},t.prototype.didDisconnect=function(t){return arguments.length?(this.delegate.didDisconnect=t,this):this.delegate.didDisconnect},t.prototype.didFail=function(t){return arguments.length?(this.delegate.didFail=t,this):this.delegate.didFail},t.prototype.hostDidConnect=function(t){this.remoteHost=t,this.delegate.didConnect&&this.delegate.didConnect(this)},t.prototype.hostDidAuthenticate=function(t,e){this.delegate.didAuthenticate&&this.delegate.didAuthenticate(t,this)},t.prototype.hostDidDeauthenticate=function(t,e){this.delegate.didDeauthenticate&&this.delegate.didDeauthenticate(t,this)},t.prototype.hostDidDisconnect=function(t){this.remoteHost=void 0,this.delegate.didDisconnect&&this.delegate.didDisconnect(this)},t.prototype.hostDidFail=function(t,e){this.delegate.didFail&&this.delegate.didFail(t,this)},t}(),N=function(t){function e(e,i){var n=t.call(this,e)||this;return n.hostUri=i,n}return i(e,t),e.prototype.host=function(){return this.hostUri},e.prototype.node=function(t){return new O(this.context,this.hostUri,t)},e.prototype.lane=function(t,e){return new L(this.context,this.hostUri,t,e)},e.prototype.downlink=function(){return new C(this.context,this,this.hostUri)},e.prototype.downlinkList=function(){return new E(this.context,this,this.hostUri)},e.prototype.downlinkMap=function(){return new V(this.context,this,this.hostUri)},e.prototype.downlinkValue=function(){return new T(this.context,this,this.hostUri)},e.prototype.command=function(t,e,i){this.context.command(this.hostUri,t,e,i)},e}(M),O=function(t){function e(e,i,n){var o=t.call(this,e)||this;return o.hostUri=i,o.nodeUri=n,o}return i(e,t),e.prototype.host=function(){return this.hostUri},e.prototype.node=function(){return this.nodeUri},e.prototype.lane=function(t){return new L(this.context,this.hostUri,this.nodeUri,t)},e.prototype.downlink=function(){return new C(this.context,this,this.hostUri,this.nodeUri)},e.prototype.downlinkList=function(){return new E(this.context,this,this.hostUri,this.nodeUri)},e.prototype.downlinkMap=function(){return new V(this.context,this,this.hostUri,this.nodeUri)},e.prototype.downlinkValue=function(){return new T(this.context,this,this.hostUri,this.nodeUri)},e.prototype.command=function(t,e){this.context.command(this.hostUri,this.nodeUri,t,e)},e}(M),L=function(t){function e(e,i,n,o){var s=t.call(this,e)||this;return s.hostUri=i,s.nodeUri=n,s.laneUri=o,s}return i(e,t),e.prototype.host=function(){return this.hostUri},e.prototype.node=function(){return this.nodeUri},e.prototype.lane=function(){return this.laneUri},e.prototype.downlink=function(){return new C(this.context,this,this.hostUri,this.nodeUri,this.laneUri)},e.prototype.downlinkList=function(){return new E(this.context,this,this.hostUri,this.nodeUri,this.laneUri)},e.prototype.downlinkMap=function(){return new V(this.context,this,this.hostUri,this.nodeUri,this.laneUri)},e.prototype.downlinkValue=function(){return new T(this.context,this,this.hostUri,this.nodeUri,this.laneUri)},e.prototype.command=function(t){this.context.command(this.hostUri,this.nodeUri,this.laneUri,t)},e}(M),I=function(t){function e(e,i,n){void 0===n&&(n={});var o=t.call(this,e,i,n)||this;return o.onWebSocketOpen=o.onWebSocketOpen.bind(o),o.onWebSocketMessage=o.onWebSocketMessage.bind(o),o.onWebSocketClose=o.onWebSocketClose.bind(o),o.onWebSocketError=o.onWebSocketError.bind(o),o}return i(e,t),Object.defineProperty(e.prototype,"WebSocket",{get:function(){return this.options.WebSocket||"undefined"!=typeof WebSocket&&WebSocket||"function"==typeof require&&require("ws")||void 0},enumerable:!0,configurable:!0}),e.prototype.isConnected=function(){return!(!this.socket||this.socket.readyState!==this.socket.OPEN)},e.prototype.open=function(){if(this.clearReconnect(),!this.socket){var t=this.WebSocket;if(!t)throw new Error("undefined WebSocket");this.options.protocols?this.socket=new t(this.hostUri,this.options.protocols):this.socket=new t(this.hostUri),this.socket.onopen=this.onWebSocketOpen,this.socket.onmessage=this.onWebSocketMessage,this.socket.onclose=this.onWebSocketClose,this.socket.onerror=this.onWebSocketError}},e.prototype.close=function(){this.clearReconnect(),this.clearIdle(),this.socket?(this.socket.close(),this.context.isOnline()||this.onWebSocketClose()):t.prototype.close.call(this)},e.prototype.push=function(t){if(this.isConnected()){this.clearIdle();var e=t.toRecon();this.socket.send(e),this.watchIdle()}else if(t instanceof d){if(!(this.sendBuffer.length<this.sendBufferSize))throw"send buffer overflow";this.sendBuffer.push(t),this.open()}},e.prototype.onWebSocketOpen=function(){if(this.isConnected()){var t=this.credentials;if(t){var e=new g(t);this.push(e)}this.onConnect();for(var i=void 0;(i=this.sendBuffer.shift())&&this.isConnected();)this.push(i);this.watchIdle()}else this.close()},e.prototype.onWebSocketMessage=function(t){var e=t.data;if("string"==typeof e){var i=s.parseRecon(e);i?this.onEnvelope(i):this.onUnknownEnvelope(e)}},e.prototype.onWebSocketClose=function(){this.socket&&(this.socket.onopen=void 0,this.socket.onmessage=void 0,this.socket.onclose=void 0,this.socket.onerror=void 0,this.socket=void 0),this.onDisconnect(),this.clearIdle(),this.isIdle()?this.close():this.context.isOnline()&&this.reconnect()},e.prototype.onWebSocketError=function(){this.onError(),this.socket&&this.socket.close()},e}(U),H=function(){function t(t){void 0===t&&(t={}),this.options=t,this.scopes=[],this.hosts={},this.downlinks={},this.downlinkCount=0,this.online=!0,this.delegate={},this.onOnline=this.onOnline.bind(this),this.onOffline=this.onOffline.bind(this),this.watchOnline(!!t.keepOnline)}return t.prototype.isOnline=function(t){if(arguments.length){if(this.online!==t){this.online=!!t;for(var e in this.hosts){var i=this.hosts[e];t?i.open():i.close()}}return this}return this.online},t.prototype.keepOnline=function(t){return arguments.length?(this.options.keepOnline!==t&&(this.options.keepOnline=t,this.watchOnline(!!t)),this):!!this.options.keepOnline},t.prototype.watchOnline=function(t){"object"==typeof window&&(t?(window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)):(window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)))},t.prototype.onOnline=function(t){this.isOnline(!0)},t.prototype.onOffline=function(t){this.isOnline(!1)},t.prototype.getHost=function(t){return this.hosts[t]},t.prototype.openHost=function(t){var e=this.hosts[t];return e||(e=new I(this,t,this.options),this.hosts[t]=e),e},t.prototype.closeHost=function(t){this.hosts[t.hostUri]&&(delete this.hosts[t.hostUri],t.closeUp())},t.prototype.getDownlink=function(t,e,i){var n=this.downlinks[t];if(n){var o=n[e];if(o)return o[i]}},t.prototype.openDownlink=function(t){var e=t.host(),i=t.node(),n=t.lane(),o=this.downlinks[e];o||(o={},this.downlinks[e]=o);var s=o[i];if(s||(s={},o[i]=s),s[n])throw"duplicate downlink";s[n]=t,this.downlinkCount+=1;this.openHost(e).openDownlink(t)},t.prototype.unlinkDownlink=function(t){var e=t.host(),i=this.getHost(e);i&&i.unlinkDownlink(t)},t.prototype.closeDownlink=function(t){var e=t.host(),i=t.node(),n=t.lane(),o=this.downlinks[e];if(o){var s=o[i];if(s&&s[n]){this.downlinkCount-=1,delete s[n],0===Object.keys(s).length&&(delete o[i],0===Object.keys(o).length&&delete this.downlinks[e]);var r=this.getHost(e);r&&r.closeDownlink(t)}}},t.prototype.downlink=function(){return new C(this)},t.prototype.downlinkList=function(){return new E(this)},t.prototype.downlinkMap=function(){return new V(this)},t.prototype.downlinkValue=function(){return new T(this)},t.prototype.openScope=function(t){this.scopes.push(t)},t.prototype.closeScope=function(t){var e=this.scopes.indexOf(t);e>=0&&(this.scopes.splice(e,1),t.closeUp())},t.prototype.host=function(t){return new N(this,t)},t.prototype.node=function(t,i){return void 0===i&&(i=t,t=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(t,i)),new O(this,t,i)},t.prototype.lane=function(t,i,n){return void 0===n&&(n=i,i=t,t=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(t,i)),new L(this,t,i,n)},t.prototype.authenticate=function(t,e){this.openHost(t).authenticate(e)},t.prototype.command=function(t,i,n,o){3===arguments.length&&(o=n,n=i,i=t,t=e.Uri.getHostUri(i),i=e.Uri.unresolveUri(t,i));this.openHost(t).command(i,n,o)},t.prototype.close=function(){var t=this.scopes;this.scopes=[];for(var e=0;e<t.length;e+=1)t[e].closeUp();var i=this.downlinks;this.downlinks={},this.downlinkCount=0;for(var n in i){var o=i[n];for(var s in o){var r=o[s];for(var h in r){var l=r[h];l.closeUp();var a=this.getHost(n);a&&a.closeDownlink(l)}}}var d=this.hosts;this.hosts={};for(var n in d)d[n].closeUp()},t.prototype.didConnect=function(t){return arguments.length?(this.delegate.didConnect=t,this):this.delegate.didConnect},t.prototype.didAuthenticate=function(t){return arguments.length?(this.delegate.didAuthenticate=t,this):this.delegate.didAuthenticate},t.prototype.didDeauthenticate=function(t){return arguments.length?(this.delegate.didDeauthenticate=t,this):this.delegate.didDeauthenticate},t.prototype.didDisconnect=function(t){return arguments.length?(this.delegate.didDisconnect=t,this):this.delegate.didDisconnect},t.prototype.didFail=function(t){return arguments.length?(this.delegate.didFail=t,this):this.delegate.didFail},t.prototype.hostDidConnect=function(t){this.delegate.didConnect&&this.delegate.didConnect(t,this);for(var e=0;e<this.scopes.length;e+=1){var i=this.scopes[e];i.host()===t.hostUri&&i.hostDidConnect(t)}},t.prototype.hostDidAuthenticate=function(t,e){this.delegate.didAuthenticate&&this.delegate.didAuthenticate(t,e,this);for(var i=0;i<this.scopes.length;i+=1){var n=this.scopes[i];n.host()===e.hostUri&&n.hostDidAuthenticate(t,e)}},t.prototype.hostDidDeauthenticate=function(t,e){this.delegate.didDeauthenticate&&this.delegate.didDeauthenticate(t,e,this);for(var i=0;i<this.scopes.length;i+=1){var n=this.scopes[i];n.host()===e.hostUri&&n.hostDidDeauthenticate(t,e)}},t.prototype.hostDidDisconnect=function(t){this.delegate.didDisconnect&&this.delegate.didDisconnect(t,this);for(var e=0;e<this.scopes.length;e+=1){var i=this.scopes[e];i.host()===t.hostUri&&i.hostDidDisconnect(t)}},t.prototype.hostDidFail=function(t,e){this.delegate.didFail&&this.delegate.didFail(t,e,this);for(var i=0;i<this.scopes.length;i+=1){var n=this.scopes[i];n.host()===e.hostUri&&n.hostDidFail(t,e)}},t}(),A=new H,q=A.isOnline.bind(A),j=A.keepOnline.bind(A),F=A.downlink.bind(A),P=A.downlinkList.bind(A),_=A.downlinkMap.bind(A),B=A.downlinkValue.bind(A),z=A.host.bind(A),K=A.node.bind(A),G=A.lane.bind(A),J=A.authenticate.bind(A),Q=A.command.bind(A);t.client=A,t.isOnline=q,t.keepOnline=j,t.downlink=F,t.downlinkList=P,t.downlinkMap=_,t.downlinkValue=B,t.host=z,t.node=K,t.lane=G,t.authenticate=J,t.command=Q,t.Envelope=s,t.EventMessage=a,t.CommandMessage=d,t.LinkRequest=p,t.LinkedResponse=u,t.SyncRequest=c,t.SyncedResponse=f,t.UnlinkRequest=y,t.UnlinkedResponse=v,t.AuthRequest=g,t.AuthedResponse=m,t.DeauthRequest=w,t.DeauthedResponse=k,t.RemoteHost=U,t.Downlink=b,t.EventDownlink=C,t.ListDownlink=E,t.MapDownlink=V,t.ValueDownlink=T,t.Scope=M,t.HostScope=N,t.NodeScope=O,t.LaneScope=L,t.Client=H,Object.defineProperty(t,"__esModule",{value:!0})});